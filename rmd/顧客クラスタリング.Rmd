---
title: "顧客クラスタリング"
author: "Kotsubo Takuto"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    code_folding: hide
    highlight: kate
    md_extensions: -ascii_identifiers
---

目的：顧客情報を充実させ, 既存の情報と追加した応報を基に顧客をクラスタリングする.

```{r option, echo=FALSE, cache=FALSE,warning=FALSE}
library(knitr)
library(rmdformats)
## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

```{r,echo=FALSE}
library(DBI)  # 必須ではないらしい
library(RPostgreSQL)
library(dplyr)
```

```{r set databese,include=FALSE}
con <- dbConnect(PostgreSQL(), host="192.168.11.16", 
                 port=5432, 
                 dbname="datacom2017", 
                 user="postgres", 
                 password="postgres")

scan_query <- function(query_path) {
  return (
    scan(query_path, what='', quote='', sep='\n', comment.char = '', encoding='UTF-8') %>%
      gsub(pattern='--.*$', replacement='') %>% # 正規表現でコメントアウトを消す
      paste0(collapse=' ')
  )
  }
dbGetQuery(con,"SET CLIENT_ENCODING TO 'shift-jis';")
```

# 顧客データの読み込み

```{r}
sql <- scan_query("C:/Users/SHIO-160412-4/Desktop/data-competition/sql/tmp.sql")
customer_data <- dbGetQuery(con,sql)
glimpse(customer_data)
```

顧客データに対して, 平日の午前,夕方,夜, 土日の午前,夕方,夜の六項目での施術回数を記録しました.
また, お直し回数, 商品購入合計金額, 来店間隔を記録しました.

# データ整理

フリー女性, フリー男性, 顧客情報なしのデータを消去する.

```{r}
customer_data <- customer_data[is.na(customer_data$comment),]
```


# 基本データ分析

追加した情報とあわせて, 基本的な内容を概観する.

## 顧客年齢ヒストグラム

```{r}
hist(customer_data$birth_age,breaks=seq(1915,2015,by=10),xlab = "顧客年齢",main='')
```

## 初回来店ヒストグラム

```{r}
hist(customer_data$first_year,breaks=seq(1980,2018,by=2),xlab = "初回来店年",main='')
```

## アイテム購入金額ヒストグラム

```{r}
hist(customer_data$total_item_money,breaks=seq(0,900000,by=10000),xlab = "アイテム購入金額",main='')
```

## 来店間隔ヒストグラム

```{r}
hist(customer_data$visit_interval,breaks=seq(0,750,by=15),xlab = "顧客来店間隔",main='')
```

## 各期ごとの来店回数 

平日, 土日ともに夕方の会計回数が多い.

```{r}
visit_count <- customer_data %>% 
  summarise(morning_weekday = sum(morning_count_weekday),
            evening_weekday = sum(evening_count_weekday),
            night_weekday = sum(night_count_weekday),
            morning_holiday = sum(morning_count_holiday),
            evening_holiday = sum(evening_count_holiday),
            night_holiday = sum(night_count_holiday))
kable(visit_count)
```

## お直し回数

お直しは意外と少ない. 会計明細からお直しの製品番号idの出現をカウントすると603回でした.

```{r}
table(customer_data$remake_count) %>% 
  as.data.frame() %>% t() %>% 
  kable()
```

# クラスタリング分析

基本的な分析, および追加したデータの概観を確認したところで, クラスタリングをしてみよう.
ここからなんとなく python 使います.
